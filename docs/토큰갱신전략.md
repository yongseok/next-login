# í† í° ê°±ì‹  ì „ëµ

ğŸ”‘ í™•ì¸ë§í¬ ë¨¼ì € í™•ì¸í•  ê²ƒ!

https://authjs.dev/guides/refresh-token-rotation

---

### **1. Next.js ë¯¸ë“¤ì›¨ì–´ì™€ ì œì•½ ì‚¬í•­**
Next.js ë¯¸ë“¤ì›¨ì–´ëŠ” ìš”ì²­-ì‘ë‹µ ì£¼ê¸°ì—ì„œ ì‘ë™í•˜ë©°, ì£¼ë¡œ ê²½ëŸ‰ ì‘ì—…(ì˜ˆ: í—¤ë” ìˆ˜ì •, ë¦¬ë””ë ‰ì…˜, ì¸ì¦ í™•ì¸)ì— ì‚¬ìš©ë©ë‹ˆë‹¤. ë¯¸ë“¤ì›¨ì–´ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì œì•½ì´ ìˆìŠµë‹ˆë‹¤:
- **Edge ëŸ°íƒ€ì„**: ê¸°ë³¸ì ìœ¼ë¡œ ë¯¸ë“¤ì›¨ì–´ëŠ” Edge ëŸ°íƒ€ì„ì—ì„œ ì‹¤í–‰ë˜ë©°, Node.js ì „ìš© API(ì˜ˆ: `fs`, `child_process`)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
- **ì„±ëŠ¥**: ë¯¸ë“¤ì›¨ì–´ëŠ” ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ì‹¤í–‰ë˜ë¯€ë¡œ, ë¬´ê±°ìš´ ì‘ì—…(ì˜ˆ: ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬)ì€ ì§€ì—° ì‹œê°„ì„ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ë¹„ë™ê¸° ì‘ì—…**: ë¹„ë™ê¸° ì‘ì—…ì€ ì§€ì›ë˜ì§€ë§Œ, ë„ˆë¬´ ê¸´ ì‘ì—…ì€ ìš”ì²­ íƒ€ì„ì•„ì›ƒì´ë‚˜ ì„±ëŠ¥ ì €í•˜ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **í™˜ê²½ í˜¸í™˜ì„±**: ë°ì´í„°ë² ì´ìŠ¤ í´ë¼ì´ì–¸íŠ¸(ì˜ˆ: Prisma)ëŠ” Edge ëŸ°íƒ€ì„ê³¼ í˜¸í™˜ë˜ì–´ì•¼ í•˜ë©°, ì¼ë¶€ ORMì€ ì¶”ê°€ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.

ì œê³µí•œ ì½”ë“œì—ì„œ `refreshAccessToken` í•¨ìˆ˜ëŠ” Prismaë¥¼ ì‚¬ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ê·¼í•˜ê³ , ì™¸ë¶€ API(ì˜ˆ: Google OAuth ì—”ë“œí¬ì¸íŠ¸)ì— ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. ì´ëŠ” ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•˜ì§€ë§Œ, ëª‡ ê°€ì§€ ì£¼ì˜í•  ì ì´ ìˆìŠµë‹ˆë‹¤.

---

### **2. ì œê³µëœ ì½”ë“œì˜ ìœ íš¨ì„± ê²€í† **
ë‹¤ì‹œ í•œ ë²ˆ ì œê³µëœ ë¯¸ë“¤ì›¨ì–´ ì½”ë“œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤:

```javascript
export async function middleware(request) {
  const session = await auth();

  // ì„¸ì…˜ì´ ìœ íš¨í•œ ê²½ìš°
  if (session && session.accessToken && session.expiresAt > Math.floor(Date.now() / 1000)) {
    return NextResponse.next();
  }

  // ì„¸ì…˜ ë§Œë£Œ ì‹œ ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ê°±ì‹ 
  if (session?.user?.id) {
    const account = await prisma.account.findFirst({
      where: { userId: session.user.id, provider: 'google' },
      select: { refresh_token: true },
    });

    if (account?.refresh_token) {
      const newTokens = await refreshAccessToken(account.refresh_token, session.user.id);
      if (newTokens) {
        const response = NextResponse.next();
        response.cookies.set('next-auth.session-token', newTokens.token, {
          httpOnly: true,
          secure: process.env.NODE_ENV === 'production',
          maxAge: 24 * 60 * 60,
        });
        return response;
      }
    }
  }

  // ì„¸ì…˜ ì—†ê±°ë‚˜ ê°±ì‹  ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
  return NextResponse.redirect(new URL('/login', request.url));
}
```

#### **ì½”ë“œì˜ ìœ íš¨ì„±**
1. **ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ (Prisma)**:
   - ì½”ë“œì—ì„œ `prisma.account.findFirst`ë¥¼ í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ `refresh_token`ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
   - PrismaëŠ” Edge ëŸ°íƒ€ì„ê³¼ í˜¸í™˜ë˜ë„ë¡ `prisma/client/edge`ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, `@prisma/adapter-libsql` ê°™ì€ Edge í˜¸í™˜ ì–´ëŒ‘í„°ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.
   - **ë¬¸ì œ**: ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ëŠ” I/O ì‘ì—…ìœ¼ë¡œ, ë¯¸ë“¤ì›¨ì–´ì˜ ì‘ë‹µ ì‹œê°„ì„ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Edge í™˜ê²½ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ í´ ê²½ìš° ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±.

2. **ì™¸ë¶€ API í˜¸ì¶œ (`refreshAccessToken`)**:
   - `refreshAccessToken` í•¨ìˆ˜ëŠ” Google OAuth ì—”ë“œí¬ì¸íŠ¸ì— HTTP ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
   - ì´ëŠ” ë¹„ë™ê¸° ì‘ì—…ìœ¼ë¡œ, Edge ëŸ°íƒ€ì„ì—ì„œ `fetch`ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ê¸°ìˆ ì ìœ¼ë¡œ ê°€ëŠ¥.
   - **ë¬¸ì œ**: ì™¸ë¶€ API ìš”ì²­ì€ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì„ ìœ ë°œí•  ìˆ˜ ìˆìœ¼ë©°, Googleì˜ ì‘ë‹µ ì‹œê°„ì´ ëŠë¦¬ê±°ë‚˜ ì‹¤íŒ¨í•˜ë©´ ë¯¸ë“¤ì›¨ì–´ê°€ ì§€ì—°ë˜ê±°ë‚˜ ì—ëŸ¬ ë°œìƒ.

3. **ì„¸ì…˜ ê°±ì‹ **:
   - ìƒˆ í† í°ìœ¼ë¡œ ì¿ í‚¤(`next-auth.session-token`)ë¥¼ ê°±ì‹ í•˜ëŠ” ë¡œì§ì€ ìœ íš¨í•©ë‹ˆë‹¤.
   - NextAuthì˜ ì„¸ì…˜ í† í°ì€ `httpOnly` ì¿ í‚¤ë¡œ ê´€ë¦¬ë˜ë©°, ë¯¸ë“¤ì›¨ì–´ì—ì„œ ìˆ˜ì • ê°€ëŠ¥.

4. **Edge ëŸ°íƒ€ì„ í˜¸í™˜ì„±**:
   - Prismaì™€ `fetch`ëŠ” Edge ëŸ°íƒ€ì„ì—ì„œ ì‘ë™ ê°€ëŠ¥í•˜ì§€ë§Œ, Prismaì˜ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •ì´ Edge í˜¸í™˜ ë“œë¼ì´ë²„(ì˜ˆ: `libsql`, `PlanetScale`)ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨.
   - `NEXTAUTH_SECRET`ê³¼ ê°™ì€ í™˜ê²½ ë³€ìˆ˜ëŠ” Edge í™˜ê²½ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥.

**ê²°ë¡ **: ì œê³µëœ ì½”ë“œëŠ” **ê¸°ìˆ ì ìœ¼ë¡œ ìœ íš¨**í•˜ì§€ë§Œ, ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ì™€ ì™¸ë¶€ API í˜¸ì¶œë¡œ ì¸í•´ ì„±ëŠ¥ ì €í•˜ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ, ë¯¸ë“¤ì›¨ì–´ëŠ” ëª¨ë“  ìš”ì²­ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ, ë¹ˆë²ˆí•œ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ì€ ë¶€ë‹´ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### **3. ì ì¬ì  ë¬¸ì œì™€ ìµœì í™” ë°©ì•ˆ**
#### **ë¬¸ì œì **
1. **ì„±ëŠ¥ ì €í•˜**:
   - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬(`prisma.account.findFirst`)ì™€ ì™¸ë¶€ API í˜¸ì¶œ(`refreshAccessToken`)ì€ ê°ê° ë„¤íŠ¸ì›Œí¬ I/Oë¥¼ ìœ ë°œ.
   - Edge í™˜ê²½ì—ì„œ ìš”ì²­ë‹¹ ìˆ˜ë°± ë°€ë¦¬ì´ˆ ì§€ì—° ê°€ëŠ¥, ì‚¬ìš©ì ê²½í—˜ì— ì˜í–¥.
2. **ë¹ˆë²ˆí•œ í˜¸ì¶œ**:
   - ëª¨ë“  ë³´í˜¸ëœ ê²½ë¡œ(`/protected/:path*`)ì—ì„œ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë˜ë¯€ë¡œ, ë§¤ ìš”ì²­ë§ˆë‹¤ ë§Œë£Œ í™•ì¸ê³¼ ê°±ì‹  ë¡œì§ì´ ì‹¤í–‰ë  ê°€ëŠ¥ì„±.
3. **ì—ëŸ¬ ì²˜ë¦¬ ë¶€ì¡±**:
   - `refreshAccessToken` ì‹¤íŒ¨ ì‹œ(ì˜ˆ: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, ë¦¬í”„ë ˆì‹œ í† í° ë§Œë£Œ) ì‚¬ìš©ìë¥¼ ë°”ë¡œ `/login`ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ì§€ë§Œ, ì—ëŸ¬ ë¡œê·¸ë‚˜ ì¬ì‹œë„ ë¡œì§ì´ ë¶€ì¡±.
4. **Edge í˜¸í™˜ì„±**:
   - Prismaê°€ Edge ëŸ°íƒ€ì„ì—ì„œ ì‘ë™í•˜ë ¤ë©´ Edge í˜¸í™˜ ë“œë¼ì´ë²„ í•„ìš”. ì˜ˆ: `@prisma/adapter-libsql` ë˜ëŠ” `@vercel/postgres`.

#### **ìµœì í™” ë°©ì•ˆ**
1. **ìºì‹± ì ìš©**:
   - ë¦¬í”„ë ˆì‹œ í† í°ì„ Redis, Vercel KV, ë˜ëŠ” ë©”ëª¨ë¦¬ ìºì‹œì— ì €ì¥í•´ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ê°ì†Œ.
   - ì˜ˆ: Redisë¡œ `refresh_token` ìºì‹±:
     ```javascript
     import { createClient } from 'redis';
     const redis = createClient({ url: process.env.REDIS_URL });
     await redis.connect();

     async function getRefreshToken(userId) {
       const cached = await redis.get(`refresh_token:${userId}`);
       if (cached) return cached;
       const account = await prisma.account.findFirst({
         where: { userId, provider: 'google' },
         select: { refresh_token: true },
       });
       if (account?.refresh_token) {
         await redis.set(`refresh_token:${userId}`, account.refresh_token, { EX: 3600 });
         return account.refresh_token;
       }
       return null;
     }
     ```

2. **ì§€ì—°ëœ ê°±ì‹  (Lazy Refresh)**:
   - ë§¤ ìš”ì²­ë§ˆë‹¤ ê°±ì‹ í•˜ì§€ ì•Šê³ , í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ `useSession` í›…ì´ë‚˜ API í˜¸ì¶œë¡œ ì„¸ì…˜ ê°±ì‹  ìš”ì²­.
   - ë¯¸ë“¤ì›¨ì–´ëŠ” ë‹¨ìˆœíˆ ì„¸ì…˜ ìœ íš¨ì„±ë§Œ í™•ì¸í•˜ê³ , ê°±ì‹ ì€ ë³„ë„ API ì—”ë“œí¬ì¸íŠ¸(`/api/auth/refresh`)ì—ì„œ ì²˜ë¦¬:
     ```javascript
     // pages/api/auth/refresh.js
     export default async function handler(req, res) {
       const session = await auth(req, res);
       if (!session?.user?.id) return res.status(401).json({ error: 'Unauthorized' });

       const account = await prisma.account.findFirst({
         where: { userId: session.user.id, provider: 'google' },
         select: { refresh_token: true },
       });

       if (account?.refresh_token) {
         const newTokens = await refreshAccessToken(account.refresh_token, session.user.id);
         if (newTokens) {
           // ìƒˆ ì„¸ì…˜ í† í° ìƒì„± ë° ì¿ í‚¤ ì„¤ì •
           return res.status(200).json({ success: true });
         }
       }
       return res.status(401).json({ error: 'Refresh failed' });
     }
     ```

3. **Edge í˜¸í™˜ Prisma ì„¤ì •**:
   - Edge ëŸ°íƒ€ì„ì—ì„œ Prisma ì‚¬ìš© ì‹œ, `@prisma/client/edge`ì™€ í˜¸í™˜ ë“œë¼ì´ë²„ ì„¤ì •:
     ```javascript
     import { PrismaClient } from '@prisma/client/edge';
     const prisma = new PrismaClient();
     ```
   - Vercel Postgres ë˜ëŠ” PlanetScale ê°™ì€ Edge í˜¸í™˜ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©.

4. **ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”**:
   - `refreshAccessToken` ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€:
     ```javascript
     async function refreshAccessToken(refreshToken, userId, retries = 1) {
       for (let attempt = 1; attempt <= retries; attempt++) {
         try {
           const response = await fetch('https://oauth2.googleapis.com/token', {
             method: 'POST',
             body: new URLSearchParams({
               client_id: process.env.GOOGLE_CLIENT_ID,
               client_secret: process.env.GOOGLE_CLIENT_SECRET,
               refresh_token: refreshToken,
               grant_type: 'refresh_token',
             }),
           });
           const tokens = await response.json();
           if (!response.ok) throw new Error(tokens.error);
           await prisma.account.update({
             where: { userId_provider: { userId, provider: 'google' } },
             data: {
               access_token: tokens.access_token,
               expires_at: Math.floor(Date.now() / 1000) + tokens.expires_in,
               refresh_token: tokens.refresh_token || refreshToken,
             },
           });
           return {
             accessToken: tokens.access_token,
             expiresAt: Math.floor(Date.now() / 1000) + tokens.expires_in,
             refreshToken: tokens.refresh_token || refreshToken,
           };
         } catch (error) {
           if (attempt === retries) throw error;
           await new Promise(resolve => setTimeout(resolve, 1000)); // 1ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„
         }
       }
     }
     ```

5. **ë¯¸ë“¤ì›¨ì–´ ê°„ì†Œí™”**:
   - ë¯¸ë“¤ì›¨ì–´ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ì™€ ê°±ì‹  ë¡œì§ì„ ìµœì†Œí™”í•˜ê³ , ì„¸ì…˜ ìœ íš¨ì„±ë§Œ í™•ì¸:
     ```javascript
     export async function middleware(request) {
       const session = await auth();
       if (session && session.expiresAt > Math.floor(Date.now() / 1000)) {
         return NextResponse.next();
       }
       return NextResponse.redirect(new URL('/login', request.url));
     }
     ```

---

### **4. `database` ì „ëµ ëŒ€ì•ˆ**
`jwt` ì „ëµ ëŒ€ì‹  `database` ì „ëµì„ ì‚¬ìš©í•˜ë©´, ë¦¬í”„ë ˆì‹œ í† í° ê´€ë¦¬ê°€ ë” ìì—°ìŠ¤ëŸ½ê²Œ í†µí•©ë©ë‹ˆë‹¤:
- `PrismaAdapter`ê°€ `refresh_token`ì„ `Account` í…Œì´ë¸”ì— ì €ì¥.
- ì„¸ì…˜ ë§Œë£Œ ì‹œ, `session` ì½œë°±ì—ì„œ ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ê°±ì‹ :
  ```javascript
  callbacks: {
    async session({ session, user }) {
      const account = await prisma.account.findFirst({
        where: { userId: user.id, provider: 'google' },
        select: { access_token: true, expires_at: true, refresh_token: true },
      });
      if (account && account.expires_at < Math.floor(Date.now() / 1000)) {
        const newTokens = await refreshAccessToken(account.refresh_token, user.id);
        if (newTokens) {
          session.accessToken = newTokens.accessToken;
          session.expiresAt = newTokens.expiresAt;
        } else {
          session.error = 'Refresh failed';
        }
      } else {
        session.accessToken = account?.access_token;
        session.expiresAt = account?.expires_at;
      }
      session.user.id = user.id;
      return session;
    },
  },
  ```

- **ë¯¸ë“¤ì›¨ì–´**:
  ```javascript
  export async function middleware(request) {
    const session = await auth();
    if (session && !session.error && session.expiresAt > Math.floor(Date.now() / 1000)) {
      return NextResponse.next();
    }
    return NextResponse.redirect(new URL('/login', request.url));
  }
  ```

---

### **5. ìš”ì•½**
- **ì½”ë“œ ìœ íš¨ì„±**: ì œê³µëœ ë¯¸ë“¤ì›¨ì–´ ì½”ë“œëŠ” ê¸°ìˆ ì ìœ¼ë¡œ ìœ íš¨í•˜ì§€ë§Œ, ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ì™€ ì™¸ë¶€ API í˜¸ì¶œë¡œ ì¸í•´ ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„± ìˆìŒ.
- **ë¬¸ì œì **: Edge ëŸ°íƒ€ì„ì—ì„œì˜ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼, ë¹ˆë²ˆí•œ ì¿¼ë¦¬, ë„¤íŠ¸ì›Œí¬ ì§€ì—°.
- **ìµœì í™” ë°©ì•ˆ**:
  1. Redis/Vercel KVë¡œ ìºì‹± ì ìš©.
  2. ê°±ì‹  ë¡œì§ì„ ë³„ë„ API ì—”ë“œí¬ì¸íŠ¸ë¡œ ë¶„ë¦¬.
  3. Edge í˜¸í™˜ Prisma ì„¤ì •.
  4. ì—ëŸ¬ ì²˜ë¦¬ ë° ì¬ì‹œë„ ë¡œì§ ê°•í™”.
- **ëŒ€ì•ˆ**: `database` ì „ëµ ì‚¬ìš© ì‹œ ë¦¬í”„ë ˆì‹œ í† í° ê´€ë¦¬ê°€ ë” ê°„ë‹¨í•˜ë©°, ë¯¸ë“¤ì›¨ì–´ ë¶€ë‹´ ê°ì†Œ.
- **ê¶Œì¥**: ë¯¸ë“¤ì›¨ì–´ëŠ” ì„¸ì…˜ ìœ íš¨ì„± í™•ì¸ì— ì§‘ì¤‘í•˜ê³ , ë¦¬í”„ë ˆì‹œ í† í° ê°±ì‹ ì€ API ì—”ë“œí¬ì¸íŠ¸ ë˜ëŠ” `session` ì½œë°±ì—ì„œ ì²˜ë¦¬.

---

ì¶”ê°€ë¡œ íŠ¹ì • ìµœì í™”(ì˜ˆ: Redis í†µí•©, API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„)ë‚˜ Edge ëŸ°íƒ€ì„ ì„¤ì •ì— ëŒ€í•œ ì½”ë“œ ì˜ˆì œê°€ í•„ìš”í•˜ë©´ ë§ì”€í•´ì£¼ì„¸ìš”!